# Security Group Configuration

# Security Group for RDS DB
resource "aws_security_group" "rds_sg" {
  vpc_id = aws_vpc.main_vpc.id

  ingress {
    from_port       = 0
    to_port         = 65535
    protocol        = "tcp"
    security_groups = [aws_security_group.lambda_sg.id]
  }

  ingress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = ["10.0.0.0/16"]  # Allow access from within the VPC
  }

  ingress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = [var.cidr_block, "128.189.204.245/32"] # Allow traffic from my IP Address & UBC
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"] # Allow all outgoing traffic
  }

  tags = {
    Name    = "${var.app_prefix}-rds-sg"
    Project = var.app_name
  }
}

# Security Group for RDS DB (Grafana 1)
resource "aws_security_group" "rds_sg_grafana1" {
  vpc_id = aws_vpc.main_vpc.id

  ingress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = [
      "34.75.153.128/32",
      "34.93.36.202/32",
      "34.122.25.189/32",
      "34.139.125.88/32",
      "20.67.29.228/32",
      "35.223.234.104/32",
      "35.188.35.239/32",
      "34.69.89.218/32",
      "34.79.82.143/32",
      "34.77.204.7/32",
      "34.140.249.6/32",
      "35.241.223.88/32",
      "104.199.42.73/32",
      "35.225.46.237/32",
      "20.67.29.233/32",
      "35.238.91.227/32",
      "35.188.111.61/32",
      "35.241.240.83/32",
      "3.70.73.127/32",
      "34.68.102.192/32",
      "34.116.86.185/32",
      "35.193.153.9/32",
      "34.138.147.250/32",
      "20.236.238.183/32",
      "35.240.68.148/32",
      "52.24.218.184/32",
      "20.67.29.224/32",
      "34.139.48.103/32",
      "35.186.156.68/32",
      "34.166.5.172/32",
      "35.240.3.33/32",
      "35.188.211.52/32",
      "35.200.157.179/32",
      "13.50.45.28/32",
      "34.89.45.33/32",
      "52.64.4.235/32",
      "35.239.142.182/32",
      "34.89.0.135/32",
      "35.195.230.234/32",
      "20.67.29.231/32",
      "35.205.153.2/32",
      "35.190.218.33/32",
      "13.232.127.226/32",
      "35.195.227.45/32",
      "52.63.186.164/32",
      "34.133.189.12/32",
      "34.138.106.25/32",
      "20.67.29.225/32",
      "34.78.215.237/32",
      "13.113.209.77/32",
      "16.78.129.243/32",
      "16.78.139.254/32",
      "34.140.126.111/32",
      "34.77.139.61/32",
      "104.199.83.1/32",
      "34.151.109.239/32",
      "35.225.14.197/32",
      "34.78.119.177/32",
      "3.29.170.21/32",
      "34.151.230.121/32"
    ]  # Allow traffic from Grafana 
  }
}

# Security Group for RDS DB (Grafana 2)
resource "aws_security_group" "rds_sg_grafana2" {
  vpc_id = aws_vpc.main_vpc.id

  ingress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = [
      "172.170.160.46/32",
      "54.255.103.207/32",
      "99.79.98.39/32",
      "35.223.104.30/32",
      "146.148.114.193/32",
      "34.121.8.98/32",
      "35.188.223.159/32",
      "35.240.23.141/32",
      "20.67.29.232/32",
      "35.186.149.28/32",
      "34.78.144.14/32",
      "104.155.17.39/32",
      "20.67.29.234/32",
      "35.232.164.62/32",
      "104.154.18.168/32",
      "34.140.131.149/32",
      "34.148.219.153/32",
      "52.189.69.217/32",
      "35.195.32.148/32",
      "3.129.236.235/32",
      "104.197.149.206/32",
      "34.71.98.16/32",
      "34.70.10.78/32",
      "35.192.9.186/32",
      "34.122.201.10/32",
      "34.66.50.58/32",
      "34.77.234.15/32",
      "34.78.51.99/32",
      "34.166.67.150/32",
      "35.205.162.147/32",
      "35.189.214.91/32",
      "18.228.84.204/32",
      "34.71.146.82/32",
      "20.67.29.235/32",
      "52.242.224.7/32",
      "35.200.163.5/32",
      "34.105.148.240/32",
      "35.195.145.128/32",
      "35.246.5.240/32",
      "34.23.182.42/32",
      "34.124.228.37/32",
      "35.232.52.64/32",
      "34.140.145.86/32",
      "34.136.227.230/32",
      "20.67.29.237/32",
      "34.121.249.58/32",
      "34.140.24.69/32",
      "35.240.65.0/32",
      "35.195.200.108/32",
      "34.166.38.54/32",
      "104.197.72.38/32",
      "35.205.214.194/32",
      "35.193.116.27/32",
      "104.197.203.224/32",
      "54.191.255.86/32",
      "34.78.119.192/32",
      "18.196.109.35/32",
      "34.66.84.48/32",
      "35.232.101.234/32",
      "34.77.66.52/32"
    ]  # Allow traffic from Grafana 
  }
}

# Security Group for RDS DB (Grafana 3)
resource "aws_security_group" "rds_sg_grafana3" {
  vpc_id = aws_vpc.main_vpc.id

  ingress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = [
      "20.67.29.236/32",
      "34.132.169.54/32",
      "20.67.29.239/32",
      "13.234.70.74/32",
      "18.229.226.84/32",
      "35.202.43.115/32",
      "34.140.222.135/32",
      "34.76.89.203/32",
      "34.124.249.232/32",
      "34.67.217.87/32",
      "20.67.29.227/32",
      "34.71.21.236/32",
      "34.79.87.153/32",
      "35.224.49.153/32",
      "34.140.80.178/32",
      "34.134.236.18/32",
      "34.79.38.7/32",
      "35.233.39.134/32",
      "34.69.204.106/32",
      "20.67.29.238/32",
      "16.16.136.87/32",
      "34.28.196.162/32",
      "34.139.32.16/32",
      "104.154.179.160/32",
      "34.68.98.63/32",
      "35.199.124.141/32",
      "34.23.153.165/32",
      "54.151.169.184/32",
      "35.239.61.132/32",
      "20.67.29.226/32",
      "34.78.254.53/32",
      "3.21.150.93/32",
      "20.236.236.93/32",
      "107.178.208.235/32",
      "35.233.87.205/32",
      "34.75.125.254/32",
      "130.211.63.98/32",
      "172.170.32.66/32",
      "104.154.148.31/32",
      "99.79.143.13/32",
      "34.77.231.182/32",
      "104.155.37.135/32",
      "104.196.112.131/32",
      "34.134.222.119/32",
      "35.200.175.68/32",
      "35.197.189.88/32",
      "34.69.227.129/32",
      "34.166.9.117/32",
      "35.222.253.67/32",
      "35.231.88.7/32",
      "34.72.94.67/32",
      "35.184.23.28/32",
      "34.30.244.87/32",
      "35.194.53.190/32",
      "20.221.43.180/32",
      "51.112.3.93/32",
      "34.70.19.238/32",
      "35.192.170.84/32",
      "35.205.135.148/32",
      "35.224.152.225/32"
    ]  # Allow traffic from Grafana 
  }
}

# Security Group for RDS DB (Grafana 4)
resource "aws_security_group" "rds_sg_grafana4" {
  vpc_id = aws_vpc.main_vpc.id

  ingress {
    from_port   = 3306
    to_port     = 3306
    protocol    = "tcp"
    cidr_blocks = [
      "20.67.29.229/32",
      "35.189.216.92/32",
      "52.230.136.32/32",
      "35.196.207.58/32",
      "35.247.201.140/32",
      "34.95.128.218/32",
      "34.76.83.209/32",
      "35.189.52.157/32",
      "34.72.240.165/32",
      "23.236.55.100/32",
      "34.71.213.69/32",
      "34.139.9.89/32",
      "34.140.174.239/32",
      "35.196.219.66/32",
      "18.180.113.16/32",
      "35.224.213.187/32",
      "35.231.42.145/32",
      "20.67.29.230/32"
    ]  # Allow traffic from Grafana 
  }
}

# Security Group for Backend Lambda
resource "aws_security_group" "lambda_sg" {
  vpc_id = aws_vpc.main_vpc.id

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"] # Allow all outgoing traffic
  }

  tags = {
    Name    = "${var.app_prefix}-lambda-sg"
    Project = var.app_name
  }
}
